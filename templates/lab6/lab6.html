{% extends "base.html" %}

{% block lab %}Лабораторная работа 6{% endblock %}

{% block main %}
<div class="page-header">
    <h1><i class="fas fa-building"></i> Аренда офисов</h1>
    <p>JSON-RPC 2.0 API, обновление списка без перезагрузки</p>
</div>

<div class="card">
    <h3 style="margin-bottom: 1rem; color: var(--secondary-color);">
        <i class="fas fa-list"></i> Список кабинетов
    </h3>

    <ul id="office-list" style="list-style: none; padding-left: 0; display: grid; gap: 12px;"></ul>
</div>

<script>
    const API_URL = '/lab6/json-rpc-api/';

    function rpc(method, params = null) {
        const payload = {
            jsonrpc: '2.0',
            method: method,
            id: Math.round(Math.random() * 1000)
        };
        if (params !== null) payload.params = params;

        return fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(r => r.json());
    }

    function handleError(data) {
        // как на рис. 31–32: switch/case
        switch (data.error.code) {
            case 1:
                alert('Вы не авторизованы, пожалуйста, авторизуйтесь');
                break;
            case 2:
                alert('Офис уже арендуется');
                break;
            case -32601:
                alert('Странная ошибка');
                break;
            default:
                alert(data.error.message || 'Ошибка');
        }
    }

    function renderOffices(officeList) {
        const ul = document.getElementById('office-list');
        ul.innerHTML = '';

        // логин текущего пользователя (если есть) — чтобы показывать кнопку "снять бронь"
        const currentLogin = "{{ session.get('login', '') }}";

        for (let i = 0; i < officeList.length; i++) {
            const office = officeList[i];

            const li = document.createElement('li');
            li.className = 'card';
            li.style.padding = '14px 16px';
            li.style.display = 'flex';
            li.style.alignItems = 'center';
            li.style.justifyContent = 'space-between';
            li.style.gap = '12px';

            const left = document.createElement('div');
            left.style.display = 'flex';
            left.style.flexDirection = 'column';
            left.style.gap = '4px';

            const title = document.createElement('div');
            title.style.fontWeight = '700';
            title.innerText = `Кабинет №${office.number}`;

            const status = document.createElement('div');
            status.style.color = 'var(--gray-color)';
            status.innerText = office.tenant ? `Арендатор: ${office.tenant}` : 'Свободен';

            left.appendChild(title);
            left.appendChild(status);

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.gap = '10px';
            right.style.alignItems = 'center';

            if (!office.tenant) {
                // как в методичке: кнопка "забронировать"
                const bookingButton = document.createElement('button');
                bookingButton.className = 'btn';
                bookingButton.innerText = 'забронировать';
                bookingButton.onclick = function () { booking(office.number); };
                right.appendChild(bookingButton);
            } else if (currentLogin && office.tenant === currentLogin) {
                // если офис забронирован текущим пользователем — даем "снять бронь"
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-secondary';
                cancelButton.innerText = 'снять бронь';
                cancelButton.onclick = function () { cancellation(office.number); };
                right.appendChild(cancelButton);
            } else {
                // занято другим пользователем
                const busy = document.createElement('span');
                busy.style.fontWeight = '600';
                busy.style.color = 'var(--danger-color)';
                busy.innerText = 'занято';
                right.appendChild(busy);
            }

            li.appendChild(left);
            li.appendChild(right);
            ul.appendChild(li);
        }
    }

    function getOfficeList() {
        rpc('info')
            .then(function (data) {
                if (data.error) {
                    handleError(data);
                } else {
                    renderOffices(data.result);
                }
            });
    }

    function booking(officeNumber) {
        rpc('booking', officeNumber)
            .then(function (data) {
                if (data.error) {
                    handleError(data);
                } else {
                    // как на рис. 26: очистить список и перерисовать
                    document.getElementById('office-list').innerHTML = '';
                    getOfficeList();
                }
            });
    }

    function cancellation(officeNumber) {
        rpc('cancellation', officeNumber)
            .then(function (data) {
                if (data.error) {
                    handleError(data);
                } else {
                    document.getElementById('office-list').innerHTML = '';
                    getOfficeList();
                }
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        getOfficeList();
    });
</script>
{% endblock %}
